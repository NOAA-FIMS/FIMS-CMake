set -x
set -e

which cmake

rm -rf _builds

cmake -H. -B_builds \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=_install \
    -DCMAKE_SHARED_LIBRARY_PREFIX_CXX=""
 

: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
  echo "could not determine R_HOME"
  exit 1
fi
CC=`"${R_HOME}/bin/R" CMD config CC`
CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`

cd src
mkdir build && cd build
cmake ../
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_SHARED_LIBS:bool=OFF \
  -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON
${R_HOME}/bin${R_ARCH_BIN}/R -q -e "library('Rcpp');library('TMB');library('RcppEigen');Rcpp::compileAttributes();"
${MAKE}



cmake --build _builds --target install --config Release

# Linux
cp _install/lib/FIMSCMake.so src/ || echo "Failed: FIMSCMake.so -> src"

# Mac
cp _install/lib/FIMSCmake.dylib src/FIMS-CMake.so || echo "Failed: FIMSCmake.dylib -> src"
